---
- hosts: all
  gather_facts: no

  vars:
    change_id: CHG0040003
    org: Default
    check_ssl: no
    uri: "https://{{ sn_instance }}.service-now.com/api/now/table"

  tasks:
    - name: Get ServiceNow Change information
      ansible.builtin.uri:
        url: "{{ uri }}/change_request?sysparm_query=number={{ change_id }}"
        user: "{{ sn_username }}"
        password: "{{ sn_password }}"
      register: change_info

    - set_fact:
        snow_change_sys_id: "{{ change_info.json.result.0.sys_id }}"

    - name: Get ServiceNow Task CI items
      ansible.builtin.uri:
        url: "{{ uri }}/task_ci?sysparm_query=task={{ snow_change_sys_id }}"
        user: "{{ sn_username }}"
        password: "{{ sn_password }}"
      register: task_infoS

    - name: Get ServiceNow CI information
      ansible.builtin.uri:
        url: "{{ uri }}/table/cmdb_ci/{{ item.ci_item.value }}"
        user: "{{ sn_username }}"
        password: "{{ sn_password }}"
      register: ci_info
      with_items:
        - "{{ task_info.json.result }}"

    - name: Collect affected CI
      ansible.builtin.set_fact:
        snow_affected_cis: "{{ snow_affected_cis | default({}) | combine ({item.json.result.asset_tag: item.json.result.name}) }}"
      with_items:
        - "{{ ci_info.results }}"

    - name: Create {{ change_id }} inventory
      awx.awx.inventory:
        name: "{{ change_id }}"
        description: "Inventory related to {{ change_id }}"
        organization: "{{ org }}"
        validate_certs: "{{ check_ssl }}"

    - name: Add host(s) to {{ change_id }} inventory
      vars:
        name: "{{ item.json.result.name }}"
        asset_tag: "{{ item.json.result.asset_tag }}"
      awx.awx.host:
        inventory: "{{ change_id }}"
        name: "{{ name }}"
        description: "CI from {{ change_id }}"
        validate_certs: "{{ check_ssl }}"
        variables:
          asset_tag: "{{ asset_tag }}"
      with_items:
        - "{{ ci_info.results }}"
